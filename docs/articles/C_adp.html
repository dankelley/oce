<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3. Analysis of acoustic-Doppler data • oce</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="3. Analysis of acoustic-Doppler data">
<meta property="og:description" content="oce">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">oce</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.8-2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/A_oce.html">1. Introduction to Oce</a>
    </li>
    <li>
      <a href="../articles/B_ctd.html">2. Analysis of CTD data</a>
    </li>
    <li>
      <a href="../articles/C_adp.html">3. Analysis of acoustic-Doppler data</a>
    </li>
    <li>
      <a href="../articles/D_map_projections.html">4. Using map projections</a>
    </li>
    <li>
      <a href="../articles/E_flags.html">5. Dealing with data-quality flags</a>
    </li>
    <li>
      <a href="../articles/F_subclassing.html">6. Subclassing oce objects</a>
    </li>
    <li>
      <a href="../articles/G_altering_defaults.html">7. Altering oce Defaults</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dankelley/oce/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>3. Analysis of acoustic-Doppler data</h1>
                        <h4 data-toc-skip class="author">Dan Kelley (<a href="https://orcid.org/0000-0001-7808-5911" class="external-link uri">https://orcid.org/0000-0001-7808-5911</a>)</h4>
            
            <h4 data-toc-skip class="date">2023-08-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/dankelley/oce/blob/HEAD/vignettes/C_adp.Rmd" class="external-link"><code>vignettes/C_adp.Rmd</code></a></small>
      <div class="hidden name"><code>C_adp.Rmd</code></div>

    </div>

    
    
<!-- HOW TO BUILD THE VIGNETTE. -->
<!-- Look in oce.Rmd for instructions. -->
<p><strong>Abstract.</strong> This vignette explains the basics of using
the oce package to handle measurements made by both mooring and ship
based acoustic Doppler profilers. As in the related vignette about
working with <a href="E_flags.html">data-quality flags</a>, the material
is organized to reflect typical workflow. See <a href="A_oce.html">the
main oce vignette</a> for general information about oce. The sample code
provided here relies on the oce package, loaded as follows.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dankelley.github.io/oce/" class="external-link">oce</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: gsw</span></span></code></pre></div>
<div class="section level2">
<h2 id="reading-adp-files">Reading adp files<a class="anchor" aria-label="anchor" href="#reading-adp-files"></a>
</h2>
<p>Acoustic Doppler profiling instruments are called ADCPs by some
manufacturers and ADPs by others. The class name <code>adp</code> is
used in oce, to handle both types. It is important to realize that there
are <em>many</em> data formats for data of this type, and that the files
are normally in a dense binary format that cannot be read with a text
editor. It is necessary to use software to work with such files.
Although oce can handle many file formats, and although its authors do
their best to keep up with changes to file formats (at least for popular
instruments), users will sometimes be forced to use manufacturer
software to read the data, or at least convert to a format that can be
manually read into R, and then converted to an <code>adp</code> object
using the <code><a href="../reference/as.adp.html">as.adp()</a></code> function.</p>
<p>Suppose <code>f</code> is a character string naming a data file. In
many cases,</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.oce.html">read.oce</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span></code></pre></div>
<p>will read the file, because <code>read.oce</code> will look inside
the file to try to guess the format. If this does not work, one ought to
try e.g.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.adp.html">read.adp</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span></code></pre></div>
<p>which, again, will try to determine which subtype of adp file has
been provided. If that fails, it might help to try a specialized
function, such as <code><a href="../reference/read.adp.rdi.html">read.adp.rdi()</a></code> for an RDI file,
<code><a href="../reference/read.adp.nortek.html">read.adp.nortek()</a></code> for a Nortek file, or
<code><a href="../reference/read.adp.sontek.html">read.adp.sontek()</a></code> for a Sontek file. (Actually, each of
these can handle a variety of sub-formats).</p>
<p>If any of these <code>read.</code> functions is called with just a
single argument naming the file, then the entire dataset will be read
in. This can be slow for large files (e.g. taking of order 0.1s per Mb),
and so it can help to use the <code>by</code> argument, e.g. for a 138Mb
file on the author’s computer,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="st">"/data/archive/sleiwex/2008/moorings/m09/adp/rdi_2615/raw/adp_rdi_2615.000"</span></span>
<span><span class="va">dall</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.oce.html">read.oce</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span></code></pre></div>
<p>takes 15.2s of user time, but</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d100</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.oce.html">read.oce</a></span><span class="op">(</span><span class="va">f</span>, by<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>takes 0.2s. It is also possible to window the data, using the
<code>from</code> and <code>to</code> arguments, which (like
<code>by</code>) can be integers that count ensembles (or “profiles”) or
a POSIX time (see <code><a href="../reference/read.adp.html">?read.adp</a></code>). For example, the adp dataset
provided by oce was read with</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/read.oce.html">read.oce</a></span><span class="op">(</span><span class="va">f</span>, from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2008-06-26"</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span>,</span>
<span>    to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2008-06-27"</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="st">"60:00"</span>,</span>
<span>    latitude<span class="op">=</span><span class="fl">47.88126</span>, longitude<span class="op">=</span><span class="op">-</span><span class="fl">69.73433</span><span class="op">)</span></span></code></pre></div>
<p>with <code>f</code> as defined above. This also illustrates that it
is possibly to specify the location of an instrument; the further
processing that was done to create <code>data(adp)</code> will be
explained in due course.</p>
<p>+<strong>Note</strong>: Users who are not familiar with ADP data may
noticed that there is a combination of many file types when dealing with
ADP data. Some of these include: .ENR, which are raw data only received
from the ADP, .ENS, similar to .ENR but also contain data merged from
other file types without processing, .ENX, merged data that are
processed including calculations to transformed data including east,
north, and vertical velocities, .STA, which are a short term average of
measurements, and .LTA, which are a long term average of
measurements.</p>
</div>
<div class="section level2">
<h2 id="summarizing-adp-data">Summarizing adp data<a class="anchor" aria-label="anchor" href="#summarizing-adp-data"></a>
</h2>
<p>The generic function <code>summary</code> provides a useful overview
of an adp data object. For example,</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">adp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">adp</span><span class="op">)</span></span></code></pre></div>
<p>(results not shown the goal is to encourage the user to try this!)
shows the sort of information normally present in an RDI file. Other
manufacturer types will have somewhat different summaries, because both
the metadata and the data differ from instrument to instrument. In all
cases, there will be a vector holding time (named <code>time</code>),
another holding the distance from instrument to the centre of a
measurement bin, measured along a line equidistant between the beams
(named <code>distance</code>), along with an array holding velocity
(named <code>v</code>). (Other arrays may include, as in this RDI case,
<code>q</code> for data quality, <code>a</code> for backscatter
amplitude, and <code>g</code> for percentage goodness.)</p>
<p>Note that the summary reveals that instrument had been set up to
record in <code>beam</code> coordinates, but that processing had been
done to convert to <code>enu</code> (east-north-up) coordinates.</p>
<p><strong>Exercise 1.</strong> Determine the name of the
<code>metadata</code> item that holds the coordinate system of an adp
object.</p>
<p>After completing Exercise 1, the user will notice that both
<code>latitude</code> and <code>longitude</code> are available in the
metadata for this built-in, moored, adp dataset. It should be noted that
if this dataset was a ship-based adp dataset, then <code>latitude</code>
and <code>longitude</code> would not be included. Instead, the data
would include <code>firstLatitude</code>, <code>firstLongitude</code>,
<code>lastLatitude</code>, and <code>lastLongitude</code>, which provide
an indication of the ship drift during sampling.</p>
</div>
<div class="section level2">
<h2 id="changing-coordinate-systems">Changing coordinate systems<a class="anchor" aria-label="anchor" href="#changing-coordinate-systems"></a>
</h2>
<p>It is critical for analysts to be aware of the coordinate system of
an adp dataset, simply because those systems are so different. In what
oce calls the <code>beam</code> system, velocities in each of the
acoustic beams are measured along the slant angle of the beam. These
data may be combined (using a transformation matrix which is part of the
metadata displayed with the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function) into what
oce calls a <code>xyz</code> system that is Cartesian and fixed to the
instrument. Since instruments record heading, pitch, and roll, the
<code>xyz</code> velocities can be converted easily to <code>enu</code>
velocities.</p>
<p>In some applications, the scientific focus is primarily on the
<code>enu</code> data, but it is a good idea to calculate and study the
data at all stages of processing. Thus, although the
<code><a href="../reference/toEnu.html">toEnu()</a></code> function will convert data measured in any
coordinate system into an <code>enu</code> variant, many analysts will
do something along the lines of</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.oce.html">read.oce</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="va">xyx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beamToXyz.html">beamToXyz</a></span><span class="op">(</span><span class="va">beam</span><span class="op">)</span></span>
<span><span class="va">enu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/xyzToEnu.html">xyzToEnu</a></span><span class="op">(</span><span class="va">xyz</span>, declination<span class="op">=</span><span class="op">-</span><span class="fl">18.1</span><span class="op">)</span></span></code></pre></div>
<p>where the declination illustrated is the value used in creating the
<code>data(adp)</code> dataset. (Compensating for declination is
necessary because compasses are calibrated at a particular place and
time, and compasses have no way of “knowing” the local angle between
true north and magnetic north.)</p>
</div>
<div class="section level2">
<h2 id="plotting">Plotting<a class="anchor" aria-label="anchor" href="#plotting"></a>
</h2>
<p>The generic <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function is specialized to handle adp
objects in a variety of simple but helpful ways. The type of plot is
determined by the <code>which</code> argument. The default for
<code>which</code> is to create a multi-panel image plot that shows
time-space dependence for each velocity component. The number of panels
depends on the number of beams used by the instrument, and each one has
a label indicating the component name. For example,</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">adp</span><span class="op">)</span></span></code></pre></div>
<p><img src="C_adp_files/figure-html/unnamed-chunk-10-1.png" width="432"></p>
<p>has velocity panels named <code>east</code>, <code>north</code> and
<code>up</code>, along with one named <code>error</code>, which is an
estimate of the velocity-inference error.</p>
<p>Options to this plot variant can be used to control how distance from
instrument is shown (which can be useful in visualizing data from
upward- and downward-aligned instruments), what colours are used to
represent the signals, etc.</p>
<p>Dozens of other plot types are also provided; see
<code><a href="../reference/plot-adp-method.html">?"plot,adp-method"</a></code> for details – but be warned that a
complex plot requires many arguments!</p>
<p>When dealing with ship-based adp data, in order to get the true
<code>east</code>, <code>north</code>, and <code>up</code> velocity, the
user must remove the speed of the ship. To do this, use the
<code><a href="../reference/subtractBottomVelocity.html">subtractBottomVelocity()</a></code> function, which subtracts the
bottom tracking velocities from an adp object.</p>
<p><strong>Exercise 2.</strong> Create a u-v scatterplot.</p>
<p><strong>Exercise 3.</strong> Write the steps to plot the
<code>east</code>, <code>north</code>, and <code>up</code> velocity
without the speed of the ship for a file named
<code>COR2019002_20190818T064815_007_000000.ENS</code>.</p>
</div>
<div class="section level2">
<h2 id="subsetting">Subsetting<a class="anchor" aria-label="anchor" href="#subsetting"></a>
</h2>
<p>Adp data can be subsetted in a wide variety of ways, e.g.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">adp</span>, <span class="va">distance</span><span class="op">&lt;</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="C_adp_files/figure-html/unnamed-chunk-11-1.png" width="432"></p>
<p>plots only data within 20m of the instrument. See
<code><a href="../reference/subset-adp-method.html">?"subset,adp-method"</a></code> for more on subsetting.</p>
<p><strong>Exercise 4.</strong> Plot the adp data for the first half of
the sampling interval.</p>
</div>
<div class="section level2">
<h2 id="accessing-data-within-adp-objects">Accessing data within adp objects<a class="anchor" aria-label="anchor" href="#accessing-data-within-adp-objects"></a>
</h2>
<p>All oce objects share a common framework, with so-called “slots” for
metadata, data, and processing log. It is possible to examine, and
modify, the elements of each of these slots using base R constructs, but
it is usually better to use oce accessor functions. The details are
provided with <code><a href="../reference/sub-sub-adp-method.html">?"[[,adp-method"</a></code> and
<code><a href="../reference/sub-subset-adp-method.html">?"[[&lt;-,adp-method"</a></code>, but a few examples should suffice to
sketch the general pattern.</p>
<p>For example,</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">distance</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"distance"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>extracts the times and distances of the profiles within
<code>data(adp)</code>, while the array holding the velocities is
extract with</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"v"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>Altering values uses the <code>[[</code> to the left of the
assignment operator, but this is not commonly required in simple work,
so it is best for readers to focus first on accessing data. The
exercises may help with this.</p>
<p>Some of the fields contained in adp objects, particularly the
amplitude, correlation, and percent good fields (<code>a</code>,
<code>q</code>, and <code>g</code>) are stored as <code>raw</code>-type.
This is done primarily to save memory space, as expanded all of those
fields into <code>numeric</code> types can be slow and they get large
quickly. However, to actually work with the numbers, users can extract a
“numeric” version by supplying the second argument to the
<code>[[</code> function, e.g.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"a"</span>, <span class="st">"numeric"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>This has the advantage of returning an object with the same matrix
dimensions as the original (note that functions like
<code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric()</a></code> typically discard dimension information,
thereby converting an array to a vector).</p>
<p><strong>Exercise 5.</strong> Plot a time series of mid-depth and
depth-averaged eastward velocities.</p>
<p><strong>Exercise 6.</strong> Perform an eigen-analysis of eastward
and northward velocity.</p>
<p><strong>Exercise 7.</strong> Plot a time series of pressure
variations, to reveal tidal height.</p>
</div>
<div class="section level2">
<h2 id="solutions-to-exercises">Solutions to exercises<a class="anchor" aria-label="anchor" href="#solutions-to-exercises"></a>
</h2>
<p><strong>Exercise 1.</strong> Determine the name of the
<code>metadata</code> item that holds the coordinate system of an adp
object.</p>
<p><strong>Solution.</strong></p>
<p>With adp as loaded in the text, we may the names in the metadata
with:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adp</span><span class="op">[[</span><span class="st">"metadata"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>(results not shown), after which a keen eye will notice that two
elements relate to coordinates:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adp</span><span class="op">[[</span><span class="st">"originalCoordinate"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "beam"</span></span>
<span><span class="va">adp</span><span class="op">[[</span><span class="st">"oceCoordinate"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "enu"</span></span></code></pre></div>
<p>and comparison with the output of <code>summary(adp)</code> reveals
that the former is the coordinate system in which the data were
originally measured, while the latter is the coordinate system of the
transformed data. Using</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/processingLogShow.html">processingLogShow</a></span><span class="op">(</span><span class="va">adp</span><span class="op">)</span></span>
<span><span class="co">#&gt; * Processing Log</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     - 2019-08-12 15:29:36 UTC: `read.oce("/data/archive/sleiwex/2008/moorings/m09/adp/rdi_2615/raw/adp_rdi_2615.000", ...)`</span></span>
<span><span class="co">#&gt;     - 2019-08-12 15:29:36 UTC: `beamToXyzAdp(x = beam)`</span></span>
<span><span class="co">#&gt;     - 2019-08-12 15:29:36 UTC: `xyzToEnuAdp(x, declination=-18.1, debug=0)`</span></span></code></pre></div>
<p>reveals the steps in the data transformation.</p>
<p><strong>Exercise 2.</strong> Create a u-v scatterplot.</p>
<p><strong>Solution.</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">adp</span>, which<span class="op">=</span><span class="st">"uv"</span><span class="op">)</span></span></code></pre></div>
<p><img src="C_adp_files/figure-html/unnamed-chunk-18-1.png" width="288"></p>
<p><strong>Exercise 3.</strong> Write the steps to plot the
<code>east</code>, <code>north</code>, and <code>up</code> velocity
without the speed of the ship for a file named
<code>COR2019002_20190818T064815_007_000000.ENS</code>.</p>
<p><strong>Solution.</strong></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dankelley.github.io/oce/" class="external-link">oce</a></span><span class="op">)</span></span>
<span><span class="va">adcp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.adp.html">read.adp</a></span><span class="op">(</span><span class="st">"COR2019002_20190818T064815_007_000000.ENS"</span><span class="op">)</span></span>
<span><span class="va">enu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/toEnu.html">toEnu</a></span><span class="op">(</span><span class="va">adcp</span><span class="op">)</span></span>
<span><span class="va">removeShipSpeed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subtractBottomVelocity.html">subtractBottomVelocity</a></span><span class="op">(</span><span class="va">enu</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">removeShipSpeed</span>, which<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><strong>Exercise 4.</strong> Plot the adp data for the first half of
the sampling interval.</p>
<p><strong>Solution.</strong> (results not shown)</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">adp</span>, <span class="va">time</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">adp</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Exercise 5.</strong> Plot a time series of mid-depth and
depth-averaged eastward velocities.</p>
<p><strong>Solution.</strong></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"v"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co"># The second index is for bin number, the third for beam number</span></span>
<span><span class="va">midIndex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">2</span></span>
<span><span class="va">eastMid</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">[</span>, <span class="va">midIndex</span>, <span class="fl">1</span><span class="op">]</span> <span class="co"># third index is beam</span></span>
<span><span class="va">distance</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"distance"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">midIndex</span><span class="op">]</span></span>
<span><span class="fu"><a href="../reference/oce.plot.ts.html">oce.plot.ts</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">eastMid</span>, ylab<span class="op">=</span><span class="st">"Eastward velocity [m/s]"</span><span class="op">)</span></span>
<span><span class="co"># Depth mean; note that na.rm, is passed by apply() to mean()</span></span>
<span><span class="va">eastMean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span>, , <span class="fl">1</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">mean</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">eastMean</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="C_adp_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>Here, <code><a href="../reference/oce.plot.ts.html">oce.plot.ts()</a></code> is used instead of the basic R
function <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, because it provides a margin note on the
detailed time interval.</p>
<p><strong>Exercise 6.</strong> Perform an eigen-analysis of eastward
and northward velocity.</p>
<p><strong>Solution.</strong></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"v"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, , <span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"v"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, , <span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">ok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="co"># remove NA values</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="va">u</span><span class="op">[</span><span class="va">ok</span><span class="op">]</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">[</span><span class="va">ok</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">v</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; eigen() decomposition</span></span>
<span><span class="co">#&gt; $values</span></span>
<span><span class="co">#&gt; [1] 0.48350161 0.01557049</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $vectors</span></span>
<span><span class="co">#&gt;           [,1]       [,2]</span></span>
<span><span class="co">#&gt; [1,] 0.5441538 -0.8389855</span></span>
<span><span class="co">#&gt; [2,] 0.8389855  0.5441538</span></span></code></pre></div>
<p>Note that this action is equivalent to principal component analysis,
and it might be wiser to use</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">v</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>to do the analysis, which yields the same principal axes</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pr</span></span>
<span><span class="co">#&gt; Standard deviations (1, .., p=2):</span></span>
<span><span class="co">#&gt; [1] 0.6953428 0.1247818</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Rotation (n x k) = (2 x 2):</span></span>
<span><span class="co">#&gt;         PC1        PC2</span></span>
<span><span class="co">#&gt; u 0.5441538 -0.8389855</span></span>
<span><span class="co">#&gt; v 0.8389855  0.5441538</span></span></code></pre></div>
<p>but has the advantage of having associated methods, including for
plotting.</p>
<p><strong>Exercise 7.</strong> Plot a time series of pressure
variations, to reveal tidal height.</p>
<p><strong>Solution.</strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">pressure</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"pressure"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="../reference/oce.plot.ts.html">oce.plot.ts</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">pressure</span><span class="op">)</span></span></code></pre></div>
<p><img src="C_adp_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>As a matter of interest, a tidal analysis may be done with</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidem.html">tidem</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.sealevel.html">as.sealevel</a></span><span class="op">(</span><span class="va">pressure</span>, <span class="va">time</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: the tidal record is too short to fit for constituents: SA, SSA, MSM, MM, MSF, MF, ALP1, 2Q1, SIG1, Q1, RHO1, O1, TAU1, BET1, NO1, CHI1, PI1, P1, S1, PSI1, PHI1, THE1, J1, SO1, OO1, UPS1, OQ2, EPS2, 2N2, MU2, N2, NU2, GAM2, H1, H2, MKS2, LDA2, L2, T2, S2, R2, K2, MSN2, ETA2, MO3, M3, SO3, MK3, SK3, MN4, M4, SN4, MS4, MK4, S4, SK4, 2SK5, 2MN6, M6, 2MS6, 2MK6, 2SM6, MSK6, M8</span></span></code></pre></div>
<p>where the list of undetermined tidal constituents is long, because
this tidal record is so short (see <code><a href="../reference/tidem.html">?tidem</a></code>). The fitted
constituents are as follows</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co">#&gt; tidem summary</span></span>
<span><span class="co">#&gt; -------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; tidem(t = as.sealevel(pressure, time))</span></span>
<span><span class="co">#&gt; RMS misfit to data:  0.06615227 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fitted Model:</span></span>
<span><span class="co">#&gt;         Freq Amplitude Phase       p    </span></span>
<span><span class="co">#&gt; Z0    0.0000   39.0465   0.0 &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; K1    0.0418    0.0689 334.9   0.089 .  </span></span>
<span><span class="co">#&gt; M2    0.0805    1.1730 203.8 4.6e-16 ***</span></span>
<span><span class="co">#&gt; 2MK5  0.2028    0.0312 112.8   0.417    </span></span>
<span><span class="co">#&gt; 3MK7  0.2833    0.0265  87.8   0.618    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; * Processing Log</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     - 2023-08-08 19:25:01 UTC: `create 'tidem' object`</span></span>
<span><span class="co">#&gt;     - 2023-08-08 19:25:01 UTC: `tidem(t = as.sealevel(pressure, time))`</span></span></code></pre></div>
<p>(Note that it fitted for M2, but not S2, because the Rayleigh
criterion prevents inferring both, and the conventional tidal analysis
favours M2 over S2 if the time series is too short to fit for more than
one semi-diurnal constituent.)</p>
<p>A useful step might be to draw a tidal fit along with the data. It
makes sense to construct a finer time grid, to get a smooth curve, as in
the following (see <code><a href="../reference/predict.tidem.html">?predict.tidem</a></code>).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/oce.plot.ts.html">oce.plot.ts</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">pressure</span>, type<span class="op">=</span><span class="st">"p"</span>, col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="va">timePredict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, length.out<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">pressurePredict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">timePredict</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">timePredict</span>, <span class="va">pressurePredict</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="C_adp_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Dan Kelley, Clark Richards.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
