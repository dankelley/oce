<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5. Dealing with data-quality flags • oce</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="5. Dealing with data-quality flags">
<meta property="og:description" content="oce">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">oce</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2-1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/oce.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/adp.html">3. Analysis of acoustic-Doppler data</a>
    </li>
    <li>
      <a href="../articles/ctd.html">2. Analysis of CTD data</a>
    </li>
    <li>
      <a href="../articles/flags.html">5. Dealing with data-quality flags</a>
    </li>
    <li>
      <a href="../articles/map_projections.html">4. Using map projections</a>
    </li>
    <li>
      <a href="../articles/subclassing.html">6. Subclassing oce objects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dankelley/oce/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="flags_files/header-attrs-2.1/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>5. Dealing with data-quality flags</h1>
                        <h4 class="author">Dan Kelley (<a href="https://orcid.org/0000-0001-7808-5911" class="uri">https://orcid.org/0000-0001-7808-5911</a>)</h4>
            
            <h4 class="date">2020-05-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/dankelley/oce/blob/master/vignettes/flags.Rmd"><code>vignettes/flags.Rmd</code></a></small>
      <div class="hidden name"><code>flags.Rmd</code></div>

    </div>

    
    
<!-- HOW TO BUILD THE VIGNETTE. -->
<!-- Look in oce.Rmd for instructions. -->
<p><strong>Abstract.</strong> This vignette explains the basics of working with data-quality flags in oce. As in the vignette about working with <a href="adp.html">adp data</a>, the material is organized to reflect typical workflow. See the main oce <a href="oce.html">vignette</a> for general information about oce. The sample code provided here relies on the oce package, loaded as follows.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">oce</span>)
<span class="co">#&gt; Loading required package: gsw</span>
<span class="co">#&gt; Loading required package: testthat</span></pre></body></html></div>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<div id="flag-context" class="section level2">
<h2 class="hasAnchor">
<a href="#flag-context" class="anchor"></a>Flag context</h2>
<p>It is common for oceanographers to link data with “flags” that indicate data quality. This scheme permits retention of the original measurements, on the assumption that they still hold some value, while at the same time providing an indication of problems. Using flags is superior to simply deleting suspicious data, or to changing recorded values to <code>NA</code>, because it lets analysts try to recover from the difficulty, perhaps by switching to another sensor, by reducing the weights of individual data during averaging operations, etc.</p>
<p>Another advantage of using flags over simply discarding bad data is that flags can be nuanced; e.g. distinguishing between unchecked data, data thought to be good, data that are suspected of being bad, data that are sure to be faulty, etc.</p>
<p>Flags are sometimes determined by automated analysis of data (e.g. range checks on individual fields, departures from gravitational stability, loops in TS diagrams, etc.). It is common for an analyst to use such tests as a starting point for further processing that incorporates the study of graphical displays, comparison with related measurements, etc.</p>
</div>
<div id="flag-conventions" class="section level2">
<h2 class="hasAnchor">
<a href="#flag-conventions" class="anchor"></a>Flag conventions</h2>
<p>A frustrating aspect of oceanographic analysis is that different data archiving agencies employ different systems for flags. For example, the <a href="https://www.nodc.noaa.gov/woce/woce_v3/wocedata_1/whp/exchange/exchange_format_desc.htm">World Hydrographic Programme</a> designates good bottle/CTD data with a flag value of 2, whereas the <a href="https://data.nodc.noaa.gov/woa/WOD/CODES/TXT/Definition_of_Quality_Flags.txt">World Ocean Database</a> uses 0 for good data.</p>
<p>Analysts must be aware of the scheme used for a particular dataset. It is also good to be on the lookout for particular values in data, because oceanographers sometimes set suspicious values to non-physical values that are easy to recognize, e.g. -999, -99.99, or similar, and sometimes these coded values may contradict formal flags, when both are present.</p>
</div>
<div id="flag-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#flag-storage" class="anchor"></a>Flag storage</h2>
<p>Data-quality flags are stored in the <code>flags</code> entry in the <code>metadata</code> slot of <code>oce</code> objects. This entry is a list, containing items with names matching the to names of data elements that are stored in the <code>data</code> slot. Oce functions assume that the flags and the data are in one-to-one correspondence, so the flags must have the same dimensionality as the data.</p>
</div>
<div id="flag-inspection" class="section level2">
<h2 class="hasAnchor">
<a href="#flag-inspection" class="anchor"></a>Flag inspection</h2>
<p>It is possible to inspect flags using e.g.  to see flags corresponding to , but a simpler notation is also provided, with e.g.  returning the flags for the salinity data. (Note the  suffix in this notation; without that, the salinity data would be returned.)</p>
</div>
<div id="flag-creation" class="section level2">
<h2 class="hasAnchor">
<a href="#flag-creation" class="anchor"></a>Flag creation</h2>
<p>Although it is possible to set and alter flags directly, it is much better to use oce functions to do so, because (a) they will not create dimensionality or name conflicts with the data and (b) they record their actions in the object’s <code>processingLog</code> slot.</p>
<p>Creating flags is usually a three-step process:</p>
<ol style="list-style-type: decimal">
<li><p>Use <code>initializeFlagScheme</code> to establish a mapping between flag numerical value and flag meaning. This step is not strictly necessary, but it is useful because it stores the flag scheme within the object’s <code>metadata</code> slot, as a form of documentation. This step may be done only once for a given object, because changing a flag scheme in the middle of processing invites errors.</p></li>
<li><p>Use <code>initializeFlags</code> to set up space for flag storage, and to initialize values (normally to a code indicating either unchecked data or acceptable data). This may be done only once per data item.</p></li>
<li><p>Use <code>setFlags</code> to assign individual flag values to individual data. This may be used repeatedly for a given object. Indeed, as illustrated later in this document, it is common to call this function within a loop that displays a graph, invites the user to click on points to be flagged, then displays the new graph, etc.</p></li>
</ol>
<p>Note that some reading operations set up flags automatically, if the data file already holds flags. For example, <code>read.argo</code> can do this, because Argo data have a fixed flag scheme, and archived Argo data often come with flag values already inserted.</p>
</div>
<div id="handling-flags" class="section level2">
<h2 class="hasAnchor">
<a href="#handling-flags" class="anchor"></a>Handling flags</h2>
<p>As with setting flags, analysts are free to extract flag values and use them for any purpose that comes to mind. Simple cases may be handled with the oce function named <code>handleFlags</code>, which is set up to respond to particular flag values with particular actions. It has reasonable defaults for different data types, and it can detect a flag scheme that has been set up with <code>setFlagScheme</code>. The default action of setting the data that have been flagged as bad to the <code>NA</code> value may suffice in many plotting or analysis situations.</p>
</div>
</div>
<div id="sample-working-procedure" class="section level1">
<h1 class="hasAnchor">
<a href="#sample-working-procedure" class="anchor"></a>Sample working procedure</h1>
<div id="ctd-range-checks" class="section level2">
<h2 class="hasAnchor">
<a href="#ctd-range-checks" class="anchor"></a>CTD range checks</h2>
<p>(This section is an expansion of Example 1 shown by <code><a href="../reference/setFlags-ctd-method.html">?"setFlags,ctd-method"</a></code>.)</p>
<p>The oce package provides a dataset</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">oce</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">ctdRaw</span>)</pre></body></html></div>
<p>that contains some clearly anomalous values that are revealed clearly in a summary plot (Figure 1):</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">ctdRaw</span>)</pre></body></html></div>
<div class="figure">
<img src="flags_files/figure-html/unnamed-chunk-4-1.png" alt="Figure 1. Summary plot for raw CTD profile." width="700"><p class="caption">
Figure 1. Summary plot for raw CTD profile.
</p>
</div>
<p>As Figure 1 shows, <code>ctdTrim</code> removes most of the anomalous data by examining the variation of the pressure signal over time, it may also be of interest to see how well simple range checks can perform in cleaning up the data. Salinity certainly cannot be negative, but in an oceanographic setting it is common to relax that criterion somewhat, perhaps insisting that Absolute Salinity <span class="math inline">\(S_A\)</span> exceed <span class="math inline">\(25\)</span>g/kg. This value might work in other situations as well, and the same could be said of an upper limit of <span class="math inline">\(40\)</span>g/kg. Similarly, it might make sense to bound temperature between, say, <span class="math inline">\(-2^\circ\)</span>C and <span class="math inline">\(40^\circ\)</span>C for application throughout much of the world ocean.</p>
<p>These criteria can be supplied to <code>setFlags</code> in various ways, but the simplest is to create logical vectors, e.g.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">badS</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">ctdRaw</span><span class="kw">[[</span><span class="st">"data"</span>]], <span class="no">salinity</span> <span class="kw">&lt;</span> <span class="fl">25</span> <span class="kw">|</span> <span class="fl">40</span> <span class="kw">&lt;</span> <span class="no">salinity</span>)
<span class="no">badT</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">ctdRaw</span><span class="kw">[[</span><span class="st">"data"</span>]], <span class="no">temperature</span> <span class="kw">&lt;</span> -<span class="fl">2</span> <span class="kw">|</span> <span class="fl">40</span> <span class="kw">&lt;</span> <span class="no">temperature</span>)</pre></body></html></div>
<p>In the above, <code>with</code> has been used to avoid inserting <code>salinity</code> and <code>temperature</code> in the namespace, but it would also be common to use e.g.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">S</span> <span class="kw">&lt;-</span> <span class="no">ctdRaw</span><span class="kw">[[</span><span class="st">"salinity"</span>]]
<span class="no">T</span> <span class="kw">&lt;-</span> <span class="no">ctdRaw</span><span class="kw">[[</span><span class="st">"temperature"</span>]]
<span class="no">bad</span> <span class="kw">&lt;-</span> (<span class="no">S</span> <span class="kw">&lt;</span> <span class="fl">25</span> <span class="kw">|</span> <span class="fl">40</span> <span class="kw">&lt;</span> <span class="no">S</span>) <span class="kw">||</span> (<span class="no">T</span> <span class="kw">&lt;</span> -<span class="fl">2</span> <span class="kw">|</span> <span class="fl">40</span> <span class="kw">&lt;</span> <span class="no">T</span>)</pre></body></html></div>
<p>Since the goal here is to illustrate setting multiple flags, the <code>badS</code> and <code>badT</code> values will be used. The first step is to copy the original data, so that the flag operations will not alter <code>ctdRaw</code>:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">qc</span> <span class="kw">&lt;-</span> <span class="no">ctdRaw</span></pre></body></html></div>
<p>Work flow is best documented if a flag scheme is established, and the “WHP CTD exchange” scheme is a reasonable choice; using</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/initializeFlagScheme.html">initializeFlagScheme</a></span>(<span class="no">qc</span>, <span class="st">"WHP CTD"</span>)</pre></body></html></div>
<p>stores a note on the scheme in the <code>metadata</code> slot of <code>qc</code>. Importantly, however, it does <em>not</em> store any flag values. The next step is to initialize flag values. For example, to set up flag storage for salinity and temperature, use e.g.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/initializeFlags.html">initializeFlags</a></span>(<span class="no">qc</span>, <span class="st">"salinity"</span>, <span class="fl">2</span>)
<span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/initializeFlags.html">initializeFlags</a></span>(<span class="no">qc</span>, <span class="st">"temperature"</span>, <span class="fl">2</span>)</pre></body></html></div>
<p>to create storage, and initialize all entries to the <code>"acceptable"</code> value (which, for this flag scheme, is the number <code>2</code>). Once storage has been initialized for a given variable, further calls to <code>initializeFlags</code> will have no effect, apart from a warning.</p>
<p>Note that it is entirely possible to use <code>initializeFlags</code> with a numerical value for its third argument. One advantage of using <code>initializeFlagScheme</code> is that it clarifies code, but the bigger advantage is that it embeds the scheme within the object, so that a second analyst could examine it later and be clear on the meanings of the numerical codes. This is very important, because there is not much agreement within the oceanographic community on which flag scheme to use, for many data types (Argo being an exception).</p>
<p>At this stage, individual data can be flagged with <code>setFlags</code>. This function can be called any number of times. Continuing along with our example, we may mark bad salinities with</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/setFlags.html">setFlags</a></span>(<span class="no">qc</span>, <span class="st">"salinity"</span>, <span class="no">badS</span>, <span class="kw">value</span><span class="kw">=</span><span class="st">"bad"</span>)</pre></body></html></div>
<p>We can see that the flag got inserted by using <code><a href="https://rdrr.io/r/base/summary.html">summary(qc)</a></code>, but for brevity here another method is:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">qc</span><span class="kw">[[</span><span class="st">"flags"</span>]])
<span class="co">#&gt; [1] "salinity"    "temperature"</span></pre></body></html></div>
<p>Now, temperature flags may be inserted with</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/setFlags.html">setFlags</a></span>(<span class="no">qc</span>, <span class="st">"temperature"</span>, <span class="no">badT</span>, <span class="kw">value</span><span class="kw">=</span><span class="st">"bad"</span>)</pre></body></html></div>
<p>Readers ought to use <code><a href="https://rdrr.io/r/base/summary.html">summary(qc)</a></code> to get more details of how flags were handled, and how many bad salinities and temperatures were flagged.</p>
<p>If <code>qc</code> is plotted with <code><a href="https://rdrr.io/r/base/plot.html">plot(qc)</a></code>, the results will match those of <code><a href="https://rdrr.io/r/base/plot.html">plot(ctdRaw)</a></code>. This is because setting flags has no effect on plots, because it alters <em>flags</em> but not <em>data</em>. One more step is required to test whether this procedure has cleaned up the data significantly: we must “handle” the flags, using</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">qch</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/handleFlags.html">handleFlags</a></span>(<span class="no">qc</span>, <span class="kw">flags</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">3</span>:<span class="fl">9</span>)))</pre></body></html></div>
<p>Comparing Figure 1 with the summary plot for <code>qch</code> (Figure 2), constructed with</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">qch</span>)</pre></body></html></div>
<div class="figure">
<img src="flags_files/figure-html/unnamed-chunk-14-1.png" alt="Figure 2. Summary plot for range-checked CTD profile." width="700"><p class="caption">
Figure 2. Summary plot for range-checked CTD profile.
</p>
</div>
<p>shows significant improvements. The downcast and the upcast can be seen quite clearly now, although there appears to be an issue of low salinity at the turnaround point. Setting a flag for pressure increase with time will isolate the downcast somewhat, although some smoothing will be required. Another issue related to the path of the instrument is that it may have been held below the surface for a while to equilibrate. Again, a flag could be set up to remove such data. However, it ought to be noted that <code>ctdTrim</code> can be used to address issues relating to instrument movement.</p>
</div>
<div id="interactive-editing-of-ctd-profiles" class="section level2">
<h2 class="hasAnchor">
<a href="#interactive-editing-of-ctd-profiles" class="anchor"></a>Interactive editing of CTD profiles</h2>
<p>(This section is an expansion of Example 2 shown by <code><a href="../reference/setFlags-ctd-method.html">?"setFlags,ctd-method"</a></code>.)</p>
<p>The <code>ctd</code> dataset provided by the <code>oce</code> package is similar to <code>ctdRaw</code>, except that only downcast data are provided. Even so, there are still some points that might be considered suspicious. A common way to find such points is to plot TS diagrams, looking for decreases in density with depth.</p>
<p>Running the following code in an interactive session will demonstrate a simple way to use a TS diagram to identify suspicious data. Pasting this into an R console will show a plot with lines between measurements made at successive depths. Clicking on any point will flag it, and so the point will then disappear on the plot. Clicking to the right of the plot frame will exit the procedure, after which <code>qc</code> is a ctd object with flags as set, and data set to <code>NA</code> where these flags indicate bad data.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">eos</span><span class="kw">=</span><span class="st">"gsw"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">ctd</span>)
<span class="no">qc</span> <span class="kw">&lt;-</span> <span class="no">ctd</span>
<span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/initializeFlagScheme.html">initializeFlagScheme</a></span>(<span class="no">qc</span>, <span class="st">"WHP CTD"</span>)
<span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/initializeFlags.html">initializeFlags</a></span>(<span class="no">qc</span>, <span class="st">"salinity"</span>, <span class="fl">2</span>)
<span class="no">Sspan</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="no">qc</span><span class="kw">[[</span><span class="st">"SA"</span>]]))
<span class="no">Tspan</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="no">qc</span><span class="kw">[[</span><span class="st">"CT"</span>]]))
<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">qc</span><span class="kw">[[</span><span class="st">"SA"</span>]])
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">1</span>))
<span class="fu"><a href="../reference/plotTS.html">plotTS</a></span>(<span class="no">qc</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"o"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Click on bad points; quit by clicking to right of plot"</span>)
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">n</span>)) {
    <span class="no">xy</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/locator.html">locator</a></span>(<span class="fl">1</span>)
    <span class="kw">if</span> (<span class="no">xy</span>$<span class="no">x</span> <span class="kw">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="st">"usr"</span>)[<span class="fl">2</span>])
        <span class="kw">break</span>
    <span class="no">i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">qc</span><span class="kw">[[</span><span class="st">"SA"</span>]] - <span class="no">xy</span>$<span class="no">x</span>)/<span class="no">Sspan</span> + <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">qc</span><span class="kw">[[</span><span class="st">"CT"</span>]] - <span class="no">xy</span>$<span class="no">y</span>)/<span class="no">Tspan</span>)
    <span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/setFlags.html">setFlags</a></span>(<span class="no">qc</span>, <span class="st">"salinity"</span>, <span class="kw">i</span><span class="kw">=</span><span class="no">i</span>, <span class="kw">value</span><span class="kw">=</span><span class="st">"bad"</span>)
    <span class="no">qc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/handleFlags.html">handleFlags</a></span>(<span class="no">qc</span>)
    <span class="fu"><a href="../reference/plotTS.html">plotTS</a></span>(<span class="no">qc</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"o"</span>)
}</pre></body></html></div>
<p>It would be a simple matter to extend this simple example to a shiny application that displays other data. For example, there could be panels for profiles, as well as the TS plot. The system could track clicks in any of the panels, taking appropriate actions. It would be sensible to have a staged procedure, in which clicking (or brushing) in one panel would cause a replot of all panels, with the selected data indicated in some way, so that the analyst could then choose whether to go to the next stage, of clicking a button to indicate bad data. Another button might be provided to undo such operations, or to show the original data for comparison. The point is that a wide variety of flag operations are handled very easily in R, with oce.</p>
</div>
<div id="hydrographic-sections" class="section level2">
<h2 class="hasAnchor">
<a href="#hydrographic-sections" class="anchor"></a>Hydrographic sections</h2>
<p>The flag-handling functions work for a variety of oce objects. For example, sections, which are built up from a sequence of ctd profiles, are handled easily with functions of the <em>same names</em> as for the ctd case.</p>
<p>As a simple example, the following shows how to clean up the “A03” Atlantic section that is provided with oce.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">section</span>)
<span class="no">s</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/handleFlags.html">handleFlags</a></span>(<span class="no">section</span>, <span class="kw">flags</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">3</span>:<span class="fl">9</span>)))
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>, <span class="fl">1</span>))
<span class="fu"><a href="../reference/plotTS.html">plotTS</a></span>(<span class="no">section</span>)
<span class="fu"><a href="../reference/plotTS.html">plotTS</a></span>(<span class="no">s</span>)</pre></body></html></div>
<p><img src="flags_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>Note, in the above, that the archiving agency had evidently flagged not just wild data (e.g. the salinity near <span class="math inline">\(26\)</span>g/kg) but also data that were anomalous in more subtle ways (e.g. cleaning up several points that stood out from the data cloud, below <span class="math inline">\(10^\circ\)</span>C). In fact, the flags in this data set, as in most archived hydrographic data sets, are the result of a multifaceted inspection scheme that is more demanding and useful than simple range checks.</p>
</div>
</div>
<div id="acoustic-doppler-profiler-data" class="section level1">
<h1 class="hasAnchor">
<a href="#acoustic-doppler-profiler-data" class="anchor"></a>Acoustic-Doppler profiler data</h1>
<p>By now, the reader should be able to understand the following use of data-quality flags for the <code>adp</code> dataset. Note that there is only a small difference (at 8h and 20h) between the (gray) bad data as identified by the instrument and those identified by the scheme illustrated here; look near 8h and 20h. However, altering the values for <code>G</code> and <code>V4</code> will reveal that the schemes do differ.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">adp</span>)
<span class="no">v</span> <span class="kw">&lt;-</span> <span class="no">adp</span><span class="kw">[[</span><span class="st">"v"</span>]]
<span class="no">i2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="fl">FALSE</span>, <span class="kw">dim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">v</span>)) <span class="co"># construct array to match 'v'</span>
<span class="no">g</span> <span class="kw">&lt;-</span> <span class="no">adp</span><span class="kw">[[</span><span class="st">"g"</span>, <span class="st">"numeric"</span>]]
<span class="no">G</span> <span class="kw">&lt;-</span> <span class="fl">25</span>                  <span class="co"># for percent-good field, named 'g'</span>
<span class="no">V4</span> <span class="kw">&lt;-</span> <span class="fl">0.45</span>               <span class="co"># for error velocity field, in beam 4</span>
<span class="kw">for</span> (<span class="no">k</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fl">3</span>)
    <span class="no">i2</span>[,,<span class="no">k</span>] <span class="kw">&lt;-</span> ((<span class="no">g</span>[,,<span class="no">k</span>]+<span class="no">g</span>[,,<span class="fl">4</span>]) <span class="kw">&lt;</span> <span class="no">G</span>) <span class="kw">|</span> (<span class="no">v</span>[,,<span class="fl">4</span>] <span class="kw">&gt;</span> <span class="no">V4</span>)
<span class="no">adpQC2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/initializeFlags.html">initializeFlags</a></span>(<span class="no">adp</span>, <span class="st">"v"</span>, <span class="fl">2</span>)
<span class="no">adpQC2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/setFlags.html">setFlags</a></span>(<span class="no">adpQC2</span>, <span class="st">"v"</span>, <span class="no">i2</span>, <span class="fl">3</span>)
<span class="no">adpClean2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/handleFlags.html">handleFlags</a></span>(<span class="no">adpQC2</span>, <span class="kw">flags</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">3</span>), <span class="kw">actions</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"NA"</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">1</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">adp</span>, <span class="kw">which</span><span class="kw">=</span><span class="st">"u1"</span>)                  <span class="co"># original</span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">adpClean2</span>, <span class="kw">which</span><span class="kw">=</span><span class="st">"u1"</span>)            <span class="co"># altered</span></pre></body></html></div>
<p><img src="flags_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>Note, in the above, that <code>initializeFlagScheme</code> has not been used, because the author is unaware of any common notation for such data. The values used for <code>G</code> and <code>V4</code> were provided by colleagues at the Bedford Institute of Oceanography.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dan Kelley, Clark Richards.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
