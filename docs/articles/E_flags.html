<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5. Dealing with data-quality flags • oce</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="5. Dealing with data-quality flags">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">oce</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.8-4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/A_oce.html">1. Introduction to Oce</a></li>
    <li><a class="dropdown-item" href="../articles/B_ctd.html">2. Analysis of CTD data</a></li>
    <li><a class="dropdown-item" href="../articles/C_adp.html">3. Analysis of acoustic-Doppler data</a></li>
    <li><a class="dropdown-item" href="../articles/D_map_projections.html">4. Using map projections</a></li>
    <li><a class="dropdown-item" href="../articles/E_flags.html">5. Dealing with data-quality flags</a></li>
    <li><a class="dropdown-item" href="../articles/F_subclassing.html">6. Subclassing oce objects</a></li>
    <li><a class="dropdown-item" href="../articles/G_altering_defaults.html">7. Altering oce Defaults</a></li>
    <li><a class="dropdown-item" href="../articles/H_tides.html">8. Tidal Analysis</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dankelley/oce/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>5. Dealing with data-quality flags</h1>
                        <h4 data-toc-skip class="author">Dan Kelley (<a href="https://orcid.org/0000-0001-7808-5911" class="external-link uri">https://orcid.org/0000-0001-7808-5911</a>)</h4>
            
            <h4 data-toc-skip class="date">2025-01-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/dankelley/oce/blob/HEAD/vignettes/E_flags.Rmd" class="external-link"><code>vignettes/E_flags.Rmd</code></a></small>
      <div class="d-none name"><code>E_flags.Rmd</code></div>
    </div>

    
    
<!-- HOW TO BUILD THE VIGNETTE. -->
<!-- Look in oce.Rmd for instructions. -->
<p><strong>Abstract.</strong> This vignette explains the basics of
working with data-quality flags in oce. As in the vignette about working
with <a href="C_adp.html">adp data</a>, the material is organized to
reflect typical workflow. See the main oce <a href="A_oce.html">vignette</a> for general information about oce. The
sample code provided here relies on the oce package, loaded as
follows.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dankelley.github.io/oce/">oce</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: gsw</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<div class="section level3">
<h3 id="flag-context">Flag context<a class="anchor" aria-label="anchor" href="#flag-context"></a>
</h3>
<p>It is common for oceanographers to link data with “flags” that
indicate data quality. This scheme permits retention of the original
measurements, on the assumption that they still hold some value, while
at the same time providing an indication of problems. Using flags is
superior to simply deleting suspicious data, or to changing recorded
values to <code>NA</code>, because it lets analysts try to recover from
the difficulty, perhaps by switching to another sensor, by reducing the
weights of individual data during averaging operations, etc.</p>
<p>Another advantage of using flags over simply discarding bad data is
that flags can be nuanced; e.g. distinguishing between unchecked data,
data thought to be good, data that are suspected of being bad, data that
are sure to be faulty, etc.</p>
<p>Flags are sometimes determined by automated analysis of data
(e.g. range checks on individual fields, departures from gravitational
stability, loops in TS diagrams, etc.). It is common for an analyst to
use such tests as a starting point for further processing that
incorporates the study of graphical displays, comparison with related
measurements, etc.</p>
</div>
<div class="section level3">
<h3 id="flag-conventions">Flag conventions<a class="anchor" aria-label="anchor" href="#flag-conventions"></a>
</h3>
<p>A frustrating aspect of oceanographic analysis is that different data
archiving agencies employ different systems for flags. For example, the
World Hydrographic Programme designates good bottle/CTD data with a flag
value of 2, whereas the World Ocean Database (which might be available
at
<code>https://www.ncei.noaa.gov/data/oceans/woa/WOD/CODES/TXT/Definition_of_Quality_Flags.txt</code>,
although that link failed when tested on 2021-06-26) uses 0 for good
data.</p>
<p>Analysts must be aware of the scheme used for a particular dataset.
It is also good to be on the lookout for particular values in data,
because oceanographers sometimes set suspicious values to non-physical
values that are easy to recognize, e.g. -999, -99.99, or similar, and
sometimes these coded values may contradict formal flags, when both are
present.</p>
</div>
<div class="section level3">
<h3 id="flag-storage">Flag storage<a class="anchor" aria-label="anchor" href="#flag-storage"></a>
</h3>
<p>Data-quality flags are stored in the <code>flags</code> entry in the
<code>metadata</code> slot of <code>oce</code> objects. This entry is a
list, containing items with names matching the to names of data elements
that are stored in the <code>data</code> slot. Oce functions assume that
the flags and the data are in one-to-one correspondence, so the flags
must have the same dimensionality as the data.</p>
</div>
<div class="section level3">
<h3 id="flag-inspection">Flag inspection<a class="anchor" aria-label="anchor" href="#flag-inspection"></a>
</h3>
<p>It is possible to inspect flags using e.g. to see flags corresponding
to , but a simpler notation is also provided, with e.g.  returning the
flags for the salinity data. (Note the suffix in this notation; without
that, the salinity data would be returned.)</p>
</div>
<div class="section level3">
<h3 id="flag-creation">Flag creation<a class="anchor" aria-label="anchor" href="#flag-creation"></a>
</h3>
<p>Although it is possible to set and alter flags directly, it is much
better to use oce functions to do so, because (a) they will not create
dimensionality or name conflicts with the data and (b) they record their
actions in the object’s <code>processingLog</code> slot.</p>
<p>Creating flags is usually a three-step process:</p>
<ol style="list-style-type: decimal">
<li><p>Use <code>initializeFlagScheme</code> to establish a mapping
between flag numerical value and flag meaning. This step is not strictly
necessary, but it is useful because it stores the flag scheme within the
<code>metadata</code> slot of the object, as a form of documentation.
This step may be done only once for a given object, because changing a
flag scheme in the middle of processing invites errors.</p></li>
<li><p>Use <code>initializeFlags</code> to set up space for flag
storage, and to initialize values (normally to a code indicating either
unchecked data or acceptable data). This may be done only once per data
item.</p></li>
<li><p>Use <code>setFlags</code> to assign individual flag values to
individual data. This may be used repeatedly for a given object. Indeed,
as illustrated later in this document, it is common to call this
function within a loop that displays a graph, invites the user to click
on points to be flagged, then displays the new graph, etc.</p></li>
</ol>
<p>Note that some reading operations set up flags automatically, if the
data file already holds flags. For example, <code>read.argo</code> can
do this, because Argo data have a fixed flag scheme, and archived Argo
data often come with flag values already inserted.</p>
</div>
<div class="section level3">
<h3 id="handling-flags">Handling flags<a class="anchor" aria-label="anchor" href="#handling-flags"></a>
</h3>
<p>As with setting flags, analysts are free to extract flag values and
use them for any purpose that comes to mind. Simple cases may be handled
with the oce function named <code>handleFlags</code>, which is set up to
respond to particular flag values with particular actions. It has
reasonable defaults for different data types, and it can detect a flag
scheme that has been set up with <code>setFlagScheme</code>. The default
action of setting the data that have been flagged as bad to the
<code>NA</code> value may suffice in many plotting or analysis
situations.</p>
</div>
</div>
<div class="section level2">
<h2 id="sample-working-procedure">Sample working procedure<a class="anchor" aria-label="anchor" href="#sample-working-procedure"></a>
</h2>
<div class="section level3">
<h3 id="ctd-range-checks">CTD range checks<a class="anchor" aria-label="anchor" href="#ctd-range-checks"></a>
</h3>
<p>(This section is an expansion of Example 1 shown by
<code><a href="../reference/setFlags-ctd-method.html">?"setFlags,ctd-method"</a></code>.)</p>
<p>The oce package provides a dataset</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dankelley.github.io/oce/">oce</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ctdRaw</span><span class="op">)</span></span></code></pre></div>
<p>that contains anomalous values that are revealed clearly in a summary
plot (Figure 1):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ctdRaw</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="E_flags_files/figure-html/unnamed-chunk-4-1.png" alt="Figure 1. Summary plot for raw CTD profile." width="360"><p class="caption">
Figure 1. Summary plot for raw CTD profile.
</p>
</div>
<p>As Figure 1 shows, <code>ctdTrim</code> removes most of the anomalous
data by examining the variation of the pressure signal over time, it may
also be of interest to see how well simple range checks can perform in
cleaning up the data. Salinity certainly cannot be negative, but in an
oceanographic setting it is common to relax that criterion somewhat,
perhaps insisting that Absolute Salinity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mi>A</mi></msub><annotation encoding="application/x-tex">S_A</annotation></semantics></math>
exceed
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>25</mn><annotation encoding="application/x-tex">25</annotation></semantics></math>g/kg.
This value might work in other situations as well, and the same could be
said of an upper limit of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>40</mn><annotation encoding="application/x-tex">40</annotation></semantics></math>g/kg.
Similarly, it might make sense to bound temperature between, say,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>−</mi><msup><mn>2</mn><mo>∘</mo></msup></mrow><annotation encoding="application/x-tex">-2^\circ</annotation></semantics></math>C
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>40</mn><mo>∘</mo></msup><annotation encoding="application/x-tex">40^\circ</annotation></semantics></math>C
for application throughout much of the world ocean.</p>
<p>These criteria can be supplied to <code>setFlags</code> in various
ways, but the simplest is to create logical vectors, e.g.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">badS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">ctdRaw</span><span class="op">[[</span><span class="st">"data"</span><span class="op">]</span><span class="op">]</span>, <span class="va">salinity</span> <span class="op">&lt;</span> <span class="fl">25</span> <span class="op">|</span> <span class="fl">40</span> <span class="op">&lt;</span> <span class="va">salinity</span><span class="op">)</span></span>
<span><span class="va">badT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">ctdRaw</span><span class="op">[[</span><span class="st">"data"</span><span class="op">]</span><span class="op">]</span>, <span class="va">temperature</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">2</span> <span class="op">|</span> <span class="fl">40</span> <span class="op">&lt;</span> <span class="va">temperature</span><span class="op">)</span></span></code></pre></div>
<p>In the above, <code>with</code> has been used to avoid inserting
<code>salinity</code> and <code>temperature</code> in the namespace, but
it would also be common to use e.g.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">salinity</span> <span class="op">&lt;-</span> <span class="va">ctdRaw</span><span class="op">[[</span><span class="st">"salinity"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">temperature</span> <span class="op">&lt;-</span> <span class="va">ctdRaw</span><span class="op">[[</span><span class="st">"temperature"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">bad</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">salinity</span> <span class="op">&lt;</span> <span class="fl">25</span> <span class="op">|</span> <span class="fl">40</span> <span class="op">&lt;</span> <span class="va">salinity</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">temperature</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">2</span> <span class="op">|</span> <span class="fl">40</span> <span class="op">&lt;</span> <span class="va">temperature</span><span class="op">)</span></span></code></pre></div>
<p>Since the goal here is to illustrate setting multiple flags, the
<code>badS</code> and <code>badT</code> values will be used. The first
step is to copy the original data, so that the flag operations will not
alter <code>ctdRaw</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="va">ctdRaw</span></span></code></pre></div>
<p>Work flow is best documented if a flag scheme is established, and the
“WHP CTD exchange” scheme is a reasonable choice; using</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initializeFlagScheme.html">initializeFlagScheme</a></span><span class="op">(</span><span class="va">qc</span>, <span class="st">"WHP CTD"</span><span class="op">)</span></span></code></pre></div>
<p>stores a note on the scheme in the <code>metadata</code> slot of
<code>qc</code>. Importantly, however, it does <em>not</em> store any
flag values. The next step is to initialize flag values. For example, to
set up flag storage for salinity and temperature, use e.g.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initializeFlags.html">initializeFlags</a></span><span class="op">(</span><span class="va">qc</span>, <span class="st">"salinity"</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initializeFlags.html">initializeFlags</a></span><span class="op">(</span><span class="va">qc</span>, <span class="st">"temperature"</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>to create storage, and initialize all entries to the
<code>"acceptable"</code> value (which, for this flag scheme, is the
number <code>2</code>). Once storage has been initialized for a given
variable, further calls to <code>initializeFlags</code> will have no
effect, apart from a warning.</p>
<p>Note that it is entirely possible to use <code>initializeFlags</code>
with a numerical value for its third argument. One advantage of using
<code>initializeFlagScheme</code> is that it clarifies code, but the
bigger advantage is that it embeds the scheme within the object, so that
a second analyst could examine it later and be clear on the meanings of
the numerical codes. This is very important, because there is not much
agreement within the oceanographic community on which flag scheme to
use, for many data types (Argo being an exception).</p>
<p>At this stage, individual data can be flagged with
<code>setFlags</code>. This function can be called any number of times.
Continuing along with our example, we may mark bad salinities with</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setFlags.html">setFlags</a></span><span class="op">(</span><span class="va">qc</span>, <span class="st">"salinity"</span>, <span class="va">badS</span>, value <span class="op">=</span> <span class="st">"bad"</span><span class="op">)</span></span></code></pre></div>
<p>We can see that the flag got inserted by using
<code>summary(qc)</code>, but for brevity here another method is:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">qc</span><span class="op">[[</span><span class="st">"flags"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "salinity"    "temperature"</span></span></code></pre></div>
<p>Now, temperature flags may be inserted with</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setFlags.html">setFlags</a></span><span class="op">(</span><span class="va">qc</span>, <span class="st">"temperature"</span>, <span class="va">badT</span>, value <span class="op">=</span> <span class="st">"bad"</span><span class="op">)</span></span></code></pre></div>
<p>Readers ought to use <code>summary(qc)</code> to get more details of
how flags were handled, and how many bad salinities and temperatures
were flagged.</p>
<p>If <code>qc</code> is plotted with <code>plot(qc)</code>, the results
will match those of <code>plot(ctdRaw)</code>. This is because setting
flags has no effect on plots, because it alters <em>flags</em> but not
<em>data</em>. One more step is required to test whether this procedure
has cleaned up the data significantly: we must “handle” the flags,
using</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/handleFlags.html">handleFlags</a></span><span class="op">(</span><span class="va">qc</span>, flags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Comparing Figure 1 with the summary plot for <code>qch</code> (Figure
2), constructed with</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">qch</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="E_flags_files/figure-html/unnamed-chunk-14-1.png" alt="Figure 2. Summary plot for range-checked CTD profile." width="360"><p class="caption">
Figure 2. Summary plot for range-checked CTD profile.
</p>
</div>
<p>shows significant improvements. The downcast and the upcast can be
seen quite clearly now, although salinity is suspiciously low at the
turnaround point. Setting a flag for pressure increase with time will
isolate the downcast somewhat, although some smoothing will be required.
Another issue related to the path of the instrument is that it may have
been held below the surface for a while to equilibrate. Again, a flag
could be set up to remove such data. However, it ought to be noted that
<code>ctdTrim</code> can be used to address issues relating to
instrument movement.</p>
</div>
<div class="section level3">
<h3 id="interactive-editing-of-ctd-profiles">Interactive editing of CTD profiles<a class="anchor" aria-label="anchor" href="#interactive-editing-of-ctd-profiles"></a>
</h3>
<p>(This section is an expansion of Example 2 shown by
<code><a href="../reference/setFlags-ctd-method.html">?"setFlags,ctd-method"</a></code>.)</p>
<p>The <code>ctd</code> dataset provided by the <code>oce</code> package
is similar to <code>ctdRaw</code>, except that only downcast data are
provided. Even so, there are still some points that might be considered
suspicious. A common way to find such points is to plot TS diagrams,
looking for decreases in density with depth.</p>
<p>Running the following code in an interactive session will demonstrate
a simple way to use a TS diagram to identify suspicious data. Pasting
this into an R console will show a plot with lines between measurements
made at successive depths. Clicking on any point will flag it, and so
the point will then disappear on the plot. Clicking to the right of the
plot frame will exit the procedure, after which <code>qc</code> is a ctd
object with flags as set, and data set to <code>NA</code> where these
flags indicate bad data.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>eos <span class="op">=</span> <span class="st">"gsw"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ctd</span><span class="op">)</span></span>
<span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="va">ctd</span></span>
<span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initializeFlagScheme.html">initializeFlagScheme</a></span><span class="op">(</span><span class="va">qc</span>, <span class="st">"WHP CTD"</span><span class="op">)</span></span>
<span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initializeFlags.html">initializeFlags</a></span><span class="op">(</span><span class="va">qc</span>, <span class="st">"salinity"</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">Sspan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">qc</span><span class="op">[[</span><span class="st">"SA"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Tspan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">qc</span><span class="op">[[</span><span class="st">"CT"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">qc</span><span class="op">[[</span><span class="st">"SA"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotTS.html">plotTS</a></span><span class="op">(</span><span class="va">qc</span>, type <span class="op">=</span> <span class="st">"o"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Click on bad points; quit by clicking to right of plot"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/locator.html" class="external-link">locator</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">xy</span><span class="op">$</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="st">"usr"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">break</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">qc</span><span class="op">[[</span><span class="st">"SA"</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">xy</span><span class="op">$</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="va">Sspan</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">qc</span><span class="op">[[</span><span class="st">"CT"</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">xy</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="va">Tspan</span><span class="op">)</span></span>
<span>    <span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setFlags.html">setFlags</a></span><span class="op">(</span><span class="va">qc</span>, <span class="st">"salinity"</span>, i <span class="op">=</span> <span class="va">i</span>, value <span class="op">=</span> <span class="st">"bad"</span><span class="op">)</span></span>
<span>    <span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/handleFlags.html">handleFlags</a></span><span class="op">(</span><span class="va">qc</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/plotTS.html">plotTS</a></span><span class="op">(</span><span class="va">qc</span>, type <span class="op">=</span> <span class="st">"o"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>It would be a simple matter to extend this simple example to a shiny
application that displays other data. For example, there could be panels
for profiles, as well as the TS plot. The system could track clicks in
any of the panels, taking appropriate actions. It would be sensible to
have a staged procedure, in which clicking (or brushing) in one panel
would cause a replot of all panels, with the selected data indicated in
some way, so that the analyst could then choose whether to go to the
next stage, of clicking a button to indicate bad data. Another button
might be provided to undo such operations, or to show the original data
for comparison. The point is that a wide variety of flag operations are
handled very easily in R, with oce.</p>
</div>
<div class="section level3">
<h3 id="hydrographic-sections">Hydrographic sections<a class="anchor" aria-label="anchor" href="#hydrographic-sections"></a>
</h3>
<p>The flag-handling functions work for a variety of oce objects. For
example, sections, which are built up from a sequence of ctd profiles,
are handled easily with functions of the <em>same names</em> as for the
ctd case.</p>
<p>As a simple example, the following shows how to clean up the “A03”
Atlantic section that is provided with oce.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">section</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/handleFlags.html">handleFlags</a></span><span class="op">(</span><span class="va">section</span>, flags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotTS.html">plotTS</a></span><span class="op">(</span><span class="va">section</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotTS.html">plotTS</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="E_flags_files/figure-html/unnamed-chunk-16-1.png" alt="Temperature-salinity diagram for section data, with flags ignored (top) and handled (bottom)." width="360"><p class="caption">
Temperature-salinity diagram for section data, with flags ignored (top)
and handled (bottom).
</p>
</div>
<p>Note, in the above, that the archiving agency had evidently flagged
not just wild data (e.g. the salinity near
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>26</mn><annotation encoding="application/x-tex">26</annotation></semantics></math>g/kg)
but also data that were anomalous in more subtle ways (e.g. cleaning up
several points that stood out from the data cloud, below
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mo>∘</mo></msup><annotation encoding="application/x-tex">10^\circ</annotation></semantics></math>C).
In fact, the flags in this data set, as in most archived hydrographic
data sets, are the result of a multifaceted inspection scheme that is
more demanding and useful than simple range checks.</p>
</div>
</div>
<div class="section level2">
<h2 id="acoustic-doppler-profiler-data">Acoustic-Doppler profiler data<a class="anchor" aria-label="anchor" href="#acoustic-doppler-profiler-data"></a>
</h2>
<p>By now, the reader should be able to understand the following use of
data-quality flags for the <code>adp</code> dataset. Note that there is
only a small difference (at 8h and 20h) between the (gray) bad data as
identified by the instrument and those identified by the scheme
illustrated here; look near 8h and 20h. However, altering the values for
<code>G</code> and <code>V4</code> will reveal that the schemes do
differ.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">adp</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"v"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">i2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">FALSE</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span> <span class="co"># construct array to match 'v'</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">adp</span><span class="op">[[</span><span class="st">"g"</span>, <span class="st">"numeric"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">G</span> <span class="op">&lt;-</span> <span class="fl">25</span> <span class="co"># for percent-good field, named 'g'</span></span>
<span><span class="va">V4</span> <span class="op">&lt;-</span> <span class="fl">0.45</span> <span class="co"># for error velocity field, in beam 4</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">i2</span><span class="op">[</span>, , <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">g</span><span class="op">[</span>, , <span class="va">k</span><span class="op">]</span> <span class="op">+</span> <span class="va">g</span><span class="op">[</span>, , <span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">G</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">v</span><span class="op">[</span>, , <span class="fl">4</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">V4</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">adpQC2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initializeFlags.html">initializeFlags</a></span><span class="op">(</span><span class="va">adp</span>, <span class="st">"v"</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">adpQC2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setFlags.html">setFlags</a></span><span class="op">(</span><span class="va">adpQC2</span>, <span class="st">"v"</span>, <span class="va">i2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">adpClean2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/handleFlags.html">handleFlags</a></span><span class="op">(</span><span class="va">adpQC2</span>, flags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, actions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"NA"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">adp</span>, <span class="va">distance</span> <span class="op">&gt;</span> <span class="fl">35</span><span class="op">)</span>, which <span class="op">=</span> <span class="st">"u1"</span><span class="op">)</span> <span class="co"># original</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">adpClean2</span>, <span class="va">distance</span> <span class="op">&gt;</span> <span class="fl">35</span><span class="op">)</span>, which <span class="op">=</span> <span class="st">"u1"</span><span class="op">)</span> <span class="co"># altered</span></span></code></pre></div>
<div class="figure">
<img src="E_flags_files/figure-html/unnamed-chunk-17-1.png" alt="Near-surface eastward component of ADP velocity, unaltered (top) and after handling flags (bottom)." width="432"><p class="caption">
Near-surface eastward component of ADP velocity, unaltered (top) and
after handling flags (bottom).
</p>
</div>
<p>Note, in the above, that <code>initializeFlagScheme</code> has not
been used, because the author is unaware of any common notation for such
data. The values used for <code>G</code> and <code>V4</code> were
provided by colleagues at the Bedford Institute of Oceanography.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dan Kelley, Clark Richards.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
